---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# Demo Playbook
# https://cloud.redhat.com/insights/remediations/0f005621-ec29-4fcb-9b19-5e2f60fd67dc
# Generated by Red Hat Insights on Fri, 02 Oct 2020 18:36:31 GMT
# Created by rhn-support-ihands

# Users fail to login with new keys because the cloud-init versions earlier than 19.4-1 incorrectly handle multiple SSH Authorized keys
# Identifier: (advisor:aws_cloud_init_incorrectly_handles_multiple_authkeys|AWS_CLOUD_INIT_INCORRECTLY_HANDLES_MULTIPLE_AUTH_KEYS,fix)
# Version: a0c3bb241de34fbbbc140755faf38b9bae060f7f
- name: Update cloud-init package to 19.4-1 or later
  hosts: "ip-172-31-1-38.us-east-2.compute.internal,ip-172-31-7-158.us-east-2.compute.internal"
  become: true

  tasks:
    - when: ansible_distribution_major_version == "7"
      block:
        - name: Update cloud-init to the lastest version
          yum:
            name: cloud-init
            state: latest


# Upgrade packages affected by CVE-2020-1748
# Identifier: (vulnerabilities:CVE-2020-1748,fix)
# Version: cd1f91aaa235b47a06d32784c56e092cf71ee4e1
- name: update vulnerable packages
  hosts: "sso.bleischwitz.org"
  become: true
  tasks:
    - name: check for update
      shell: "{{ ansible_facts['pkg_mgr'] }} check-update -q --cve CVE-2020-1748"
      check_mode: no
      register: check_out
      failed_when: check_out.rc != 0 and check_out.rc != 100
      args:
        warn: false

    - when: check_out.rc == 100
      name: upgrade package
      shell: "{{ ansible_facts['pkg_mgr'] }} upgrade -v -y --cve CVE-2020-1748"
      args:
        warn: false

    - when: check_out.rc == 100
      name: set reboot fact
      set_fact:
        insights_needs_reboot: True

# Upgrade packages affected by CVE-2020-6825
# Identifier: (vulnerabilities:CVE-2020-6825,fix)
# Version: cd1f91aaa235b47a06d32784c56e092cf71ee4e1
- name: update vulnerable packages
  hosts: "vm37-45.gsslab.pek2.redhat.com"
  become: true
  tasks:
    - name: check for update
      shell: "{{ ansible_facts['pkg_mgr'] }} check-update -q --cve CVE-2020-6825"
      check_mode: no
      register: check_out
      failed_when: check_out.rc != 0 and check_out.rc != 100
      args:
        warn: false

    - when: check_out.rc == 100
      name: upgrade package
      shell: "{{ ansible_facts['pkg_mgr'] }} upgrade -v -y --cve CVE-2020-6825"
      args:
        warn: false

    - when: check_out.rc == 100
      name: set reboot fact
      set_fact:
        insights_needs_reboot: True

# Automatic system reboot was suppressed for this playbook.
# This play lists the systems that need to be rebooted manually for the changes to take effect.
- name: Reboot reminder
  hosts: "sso.bleischwitz.org,vm37-45.gsslab.pek2.redhat.com"
  gather_facts: False
  tasks:
    - debug:
        msg: "Automatic system reboot was suppressed for this playbook. Reboot {{inventory_hostname}} manually for the changes to take effect."
      when:
        - insights_needs_reboot is defined
        - insights_needs_reboot

- name: run insights
  hosts: "ip-172-31-1-38.us-east-2.compute.internal,ip-172-31-7-158.us-east-2.compute.internal,sso.bleischwitz.org,vm37-45.gsslab.pek2.redhat.com"
  become: True
  gather_facts: False
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false
